<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Loading an .obj object - Learn luminance</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><a href="crate-setup.html">Crate setup</a></li><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">1.</strong> Hello, World!</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chapter_1_1.html"><strong aria-hidden="true">1.1.</strong> Getting started</a></li><li class="chapter-item expanded "><a href="chapter_1_2.html"><strong aria-hidden="true">1.2.</strong> Creating a window and preparing graphics code</a></li><li class="chapter-item expanded "><a href="chapter_1_3.html"><strong aria-hidden="true">1.3.</strong> Changing the background color</a></li></ol></li><li class="chapter-item expanded "><a href="chapter_2.html"><strong aria-hidden="true">2.</strong> Your first triangle</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chapter_2_1.html"><strong aria-hidden="true">2.1.</strong> What is a triangle?</a></li><li class="chapter-item expanded "><a href="chapter_2_2.html"><strong aria-hidden="true">2.2.</strong> Shady triangle</a></li><li class="chapter-item expanded "><a href="chapter_2_3.html"><strong aria-hidden="true">2.3.</strong> Rendering our triangle</a></li></ol></li><li class="chapter-item expanded "><a href="chapter_3.html"><strong aria-hidden="true">3.</strong> Wavefront .obj loader</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chapter_3_1.html"><strong aria-hidden="true">3.1.</strong> The Wavefront .obj format</a></li><li class="chapter-item expanded "><a href="chapter_3_2.html"><strong aria-hidden="true">3.2.</strong> Defining our vertex type</a></li><li class="chapter-item expanded "><a href="chapter_3_3.html" class="active"><strong aria-hidden="true">3.3.</strong> Loading an .obj object</a></li><li class="chapter-item expanded "><a href="chapter_3_4.html"><strong aria-hidden="true">3.4.</strong> The shaders</a></li><li class="chapter-item expanded "><a href="chapter_3_5.html"><strong aria-hidden="true">3.5.</strong> Altering the graphics pipeline</a></li><li class="chapter-item expanded "><a href="chapter_3_6.html"><strong aria-hidden="true">3.6.</strong> Adding light</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Learn luminance</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#loading-an-obj-object" id="loading-an-obj-object">Loading an .obj object</a></h1>
<p>This is not really the purpose of this book but you actually need the following code in order to get the rest.
So here it is. Refer to the <a href="https://crates.io/crates/wavefront_obj">wavefront_obj</a> crate for further details. The idea here is that we define our
own <code>Obj</code> type with our own representation of what an object is. We then use <a href="https://crates.io/crates/wavefront_obj">wavefront_obj</a> to
load one object and convert it to our representation. Simple.</p>
<blockquote>
<p>Note: we also use the <a href="https://crates.io/crates/try-guard">try-guard</a> crate to convert boolean expressions to <em>try</em> values.</p>
</blockquote>
<p>However, before going any further, we are going to need to introduce a new crate: <a href="https://crates.io/crates/luminance-front">luminance-front</a>.</p>
<h2><a class="header" href="#luminance-front" id="luminance-front">luminance-front</a></h2>
<p>The examples you saw so far are simple enough they don’t require you to explicitly put type
ascriptions about the scarce resources you use. However, as soon as you need to pass them around,
you are going to hit a problem.</p>
<p><a href="https://crates.io/crates/luminance">luminance</a> — the crate — is a backend agnostic graphics API. It means that it doesn’t know which
backend it will be executed with. That information is selected by a <em>platform</em> crate — in our case,
<a href="https://crates.io/crates/luminance-glfw">luminance-glfw</a>, which in its turn depends on a <em>backend crate</em> — <a href="https://crates.io/crates/luminance-gl">luminance-gl</a> here. A type
such as <a href="https://docs.rs/luminance/latest/luminance/tess/struct.Tess.html"><code>Tess</code></a> gets its first type variable, <code>B</code>, replaced by the backend type. You didn’t notice
that because the examples from the previous chapters didn’t require passing such types around, but
now we are going to need to annotate functions’ signatures with <a href="https://crates.io/crates/luminance">luminance</a> types, and then, with
backend types.</p>
<p>You have three options:</p>
<ol>
<li>You can decide to bring in <a href="https://crates.io/crates/luminance-gl">luminance-gl</a> in your <code>Cargo.toml</code> and use the backend type that is
exported from there — a.k.a. <code>GL33</code> in our case. This will allow you to use it where backend
types are expected, but this will prevent you from using anything else but OpenGL 3.3. It ties
your code to a backend implementation.</li>
<li>You could continue declaring and passing the <code>B</code> type variable. That is a sane option if you are
writing a luminance crate or a middleware library, but it’s going to lead to not very comfortable
types to read. For instance, if you want to be able to call the <code>TessBuilder::set_vertices</code>
method, the list of constaints, types and bounds you need to add (from
<code>luminance::backend::tess</code>) is likely to discourage you.</li>
<li>You could use <a href="https://crates.io/crates/luminance-front">luminance-front</a>. The goal of this crate is to select a backend type at
compile-time and provide type aliases to remove the need to annotate functions and types with
backend types. This is a much more comfortable situation and it scales / adapts to the
compilation targets and feature gates you set in your <code>Cargo.toml</code>.</li>
</ol>
<p>We are going to use <a href="https://crates.io/crates/luminance-front">luminance-front</a> to demonstrate how easy the crate is. Basically, it will
re-export all the types from <a href="https://crates.io/crates/luminance">luminance</a>, replacing the <code>B</code> type variables (where it appears) by
the right backend type. The backend type, found at <code>luminance_front::Backend</code>, can be used if you
still need to constrain some code (typical with <code>C: GraphicsContext</code>).</p>
<p>Also, in order to make things more coherent and convenient, <a href="https://crates.io/crates/luminance-front">luminance-front</a> re-exports symbols
which don’t have the <code>B</code> type variables (it simply forwards them), so that you can remove
<code>luminance</code> from your <code>use</code> statements and make them more uniform.</p>
<blockquote>
<p>Note: keep in mind that if you use [luminance-derive], as it depends on <a href="https://crates.io/crates/luminance">luminance</a>, you will
still need to have to include <a href="https://crates.io/crates/luminance">luminance</a> in your <code>Cargo.toml</code>.</p>
</blockquote>
<p>Add this to your <code>Cargo.toml</code>:</p>
<pre><code class="language-toml">luminance-front = &quot;0.1&quot;
</code></pre>
<h2><a class="header" href="#loading-wavefront-objects" id="loading-wavefront-objects">Loading Wavefront objects</a></h2>
<p>Loading a .obj is not really part of this book, but we’ll provide the code so that you don’t have
to struggle too much. With <a href="https://crates.io/crates/luminance-front">luminance-front</a>, you will notice that the platform crate is still up
to us to decide. So if we want to be able to work for any platform crates, we need to constrain
the platform with the backend type <a href="https://crates.io/crates/luminance-front">luminance-front</a> would have selected for us. We can do that
with <code>luminance_front::Backend</code>. If <code>C</code> is the type of the platform (in our case it’s <code>GlfwSurface</code>
but it’s a good practice to be able to adapt to any), then the following is required to perform
<a href="https://crates.io/crates/luminance">luminance</a> operations:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>where C: GraphicsContext&lt;Backend = Backend&gt;
<span class="boring">}
</span></code></pre></pre>
<p>Then, loading is just a matter of following <a href="https://crates.io/crates/wavefront_obj">wavefront_obj</a>’s API:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use luminance_front::context::GraphicsContext;
use luminance_front::tess::{Tess, TessError};
use luminance_front::Backend;
use std::fs::File;
use std::io::Read as _;
use std::path::Path;
use try_guard::verify;
use wavefront_obj::obj;

// …

#[derive(Debug)]
struct Obj {
  vertices: Vec&lt;Vertex&gt;,
  indices: Vec&lt;VertexIndex&gt;,
}

impl Obj {
  fn to_tess&lt;C&gt;(
    self,
    surface: &amp;mut C,
  ) -&gt; Result&lt;Tess&lt;Vertex, VertexIndex, (), Interleaved&gt;, TessError&gt;
  where
    C: GraphicsContext&lt;Backend = Backend&gt;,
  {
    surface
      .new_tess()
      .set_mode(Mode::Triangle)
      .set_vertices(self.vertices)
      .set_indices(self.indices)
      .build()
  }

  fn load&lt;P&gt;(path: P) -&gt; Result&lt;Self, String&gt;
  where
    P: AsRef&lt;Path&gt;,
  {
    let file_content = {
      let mut file = File::open(path).map_err(|e| format!(&quot;cannot open file: {}&quot;, e))?;
      let mut content = String::new();
      file.read_to_string(&amp;mut content).unwrap();
      content
    };
    let obj_set = obj::parse(file_content).map_err(|e| format!(&quot;cannot parse: {:?}&quot;, e))?;
    let objects = obj_set.objects;

    verify!(objects.len() == 1).ok_or(&quot;expecting a single object&quot;.to_owned())?;

    let object = objects.into_iter().next().unwrap();

    verify!(object.geometry.len() == 1).ok_or(&quot;expecting a single geometry&quot;.to_owned())?;

    let geometry = object.geometry.into_iter().next().unwrap();

    println!(&quot;loading {}&quot;, object.name);
    println!(&quot;{} vertices&quot;, object.vertices.len());
    println!(&quot;{} shapes&quot;, geometry.shapes.len());

    // build up vertices; for this to work, we remove duplicated vertices by putting them in a
    // map associating the vertex with its ID
    let mut vertex_cache: HashMap&lt;obj::VTNIndex, VertexIndex&gt; = HashMap::new();
    let mut vertices: Vec&lt;Vertex&gt; = Vec::new();
    let mut indices: Vec&lt;VertexIndex&gt; = Vec::new();

    for shape in geometry.shapes {
      if let obj::Primitive::Triangle(a, b, c) = shape.primitive {
        for key in &amp;[a, b, c] {
          if let Some(vertex_index) = vertex_cache.get(key) {
            indices.push(*vertex_index);
          } else {
            let p = object.vertices[key.0];
            let position = VertexPosition::new([p.x as f32, p.y as f32, p.z as f32]);
            let vertex = Vertex { position };
            let vertex_index = vertices.len() as VertexIndex;

            vertex_cache.insert(*key, vertex_index);
            vertices.push(vertex);
            indices.push(vertex_index);
          }
        }
      } else {
        return Err(&quot;unsupported non-triangle shape&quot;.to_owned());
      }
    }

    Ok(Obj { vertices, indices })
  }
}
<span class="boring">}
</span></code></pre></pre>
<p>Basically, calling <code>Obj::load(path)</code> here will get us a <code>Result&lt;Obj, String&gt;</code>. We can then just
convert it to a <a href="https://docs.rs/luminance/latest/luminance/tess/struct.Tess.html"><code>Tess</code></a> for <a href="https://crates.io/crates/luminance">luminance</a> to process.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="chapter_3_2.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="chapter_3_4.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="chapter_3_2.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="chapter_3_4.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
